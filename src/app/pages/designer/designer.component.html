<header
    class="h-14 border-b border-zinc-800 flex items-center justify-between px-5 bg-zinc-950/80 backdrop-blur-sm z-50">
    <div class="flex items-center gap-4 shrink-0">
        <button (click)="goToBoards()" class="flex items-center gap-2 group">
            <img src="/Coschemalab.png" alt="CoSchemaLab" class="h-8 w-auto object-contain">
        </button>
        @if (editingBoardName()) {
        <input type="text" [value]="boardName()" (focus)="pushState()" (input)="boardName.set($any($event.target).value); scheduleAutoSave()"
            (blur)="editingBoardName.set(false)" (keydown.enter)="editingBoardName.set(false)"
            class="text-sm text-zinc-300 bg-zinc-800/50 border border-zinc-600 rounded px-2 py-0.5 w-32 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            placeholder="Nom du board">
        } @else {
        <button (click)="editingBoardName.set(true)" class="text-sm text-zinc-400 hover:text-zinc-300 truncate max-w-[140px] text-left">
            {{ boardName() || 'Nom du board' }}
        </button>
        }
    </div>

    <div class="flex-1 flex justify-center px-4">
        <div class="flex items-center gap-1.5 w-full max-w-xs">
            <iconify-icon icon="solar:magnifer-linear" class="text-zinc-500 text-lg shrink-0"></iconify-icon>
            <input #tableSearchInput type="text" [ngModel]="tableSearchQuery()" (ngModelChange)="tableSearchQuery.set($event)"
                placeholder="Rechercher une table..."
                title="Rechercher (Ctrl+F)"
                class="flex-1 px-3 py-1.5 rounded-md bg-zinc-900 border border-zinc-700 text-sm text-white placeholder-zinc-500 focus:border-indigo-500 outline-none">
        </div>
    </div>

    <div class="flex items-center gap-3 shrink-0">
        <div class="flex items-center gap-1 -space-x-2">
            @for (user of connectedUsers(); track user.userId) {
            <div [title]="getHoverLabel(user)"
                [ngClass]="['w-8 h-8 min-w-[32px] rounded-full border-2 border-zinc-800 flex items-center justify-center overflow-hidden ring-2 shrink-0 transition-all hover:scale-110 hover:z-10', getUserColor(user.userId), getUserRingColor(user.userId)]">
                @if (user.photoURL) {
                <img [src]="user.photoURL" [alt]="user.displayName || ''" class="w-full h-full object-cover">
                } @else {
                <span class="text-xs font-semibold text-white">{{ getInitials(user) }}</span>
                }
            </div>
            }
        </div>
        <div class="h-4 w-[1px] bg-zinc-800 mx-1"></div>
        <button (click)="logout()"
            class="flex items-center gap-2 px-3 py-1.5 rounded-md border border-zinc-800 hover:bg-zinc-900 hover:text-red-400 transition-colors text-xs font-medium">
            <iconify-icon icon="solar:logout-2-linear" class="text-sm"></iconify-icon>
            Déconnexion
        </button>
    </div>
</header>

@if (loading()) {
<div class="flex-1 flex items-center justify-center bg-[#09090b]">
    <div class="flex flex-col items-center gap-4">
        <div class="w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-zinc-500 text-sm">Chargement du board...</span>
    </div>
</div>
} @else {
<main class="flex-1 relative overflow-hidden grid-bg flex bg-[#09090b]">
    <!-- Toolbar -->
    <div class="absolute left-5 top-5 z-40 flex flex-col gap-2">
        <div
            class="bg-zinc-900/90 border border-zinc-800 backdrop-blur rounded-lg p-1.5 flex flex-col gap-1 shadow-2xl">
            <button class="p-2 rounded-md bg-zinc-800 text-white hover:bg-zinc-700 transition-colors tooltip-trigger">
                <iconify-icon icon="solar:cursor-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="addTable()"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                title="Add Table">
                <iconify-icon icon="solar:widget-add-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="copyBoardLink()"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                [title]="linkCopied() ? 'Copié !' : 'Copier le lien du board'">
                <iconify-icon [icon]="linkCopied() ? 'solar:check-circle-linear' : 'solar:link-linear'" class="text-lg"></iconify-icon>
            </button>
        </div>
        <div
            class="bg-zinc-900/90 border border-zinc-800 backdrop-blur rounded-lg p-1.5 flex flex-col gap-1 shadow-2xl">
            <button (click)="importPanelOpen.set(true); importError.set(null); importSqlContent.set(''); importJsonContent.set(''); importMode.set('sql')"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                title="Importer depuis SQL">
                <iconify-icon icon="solar:import-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="exportPanelOpen.set(true)"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                title="Exporter le schéma">
                <iconify-icon icon="solar:export-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="autoLayout()"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                title="Réorganiser les tables">
                <iconify-icon icon="solar:sort-by-alphabet-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="templatesPanelOpen.set(true)"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors"
                title="Templates de schémas">
                <iconify-icon icon="solar:widget-5-linear" class="text-lg"></iconify-icon>
            </button>
            <button (click)="validationPanelOpen.set(true)"
                class="p-2 rounded-md text-zinc-500 hover:text-white hover:bg-zinc-800 transition-colors relative"
                title="Validation du schéma">
                <iconify-icon icon="solar:danger-triangle-linear" class="text-lg"></iconify-icon>
                @if (getValidationWarnings().length > 0) {
                <span class="absolute -top-0.5 -right-0.5 min-w-[16px] h-4 px-1 rounded-full bg-amber-500/90 text-[10px] font-bold text-zinc-950 flex items-center justify-center">
                    {{ getValidationWarnings().length }}
                </span>
                }
            </button>
        </div>
    </div>

    <!-- Panneau Validation -->
    @if (validationPanelOpen()) {
    <aside class="fixed inset-y-0 right-0 w-80 border-l border-zinc-800 bg-zinc-950/95 backdrop-blur-md z-[60] flex flex-col animate-in slide-in-from-right duration-300">
        <div class="flex items-center justify-between p-6 border-b border-zinc-800">
            <h2 class="text-lg font-bold text-white">Validation</h2>
            <button (click)="validationPanelOpen.set(false)" class="text-zinc-500 hover:text-white transition-colors">
                <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
            </button>
        </div>
        <div class="p-6 flex flex-col gap-3 overflow-y-auto">
            @if (getValidationWarnings().length === 0) {
            <p class="text-sm text-zinc-500">Aucun avertissement.</p>
            } @else {
            @for (w of getValidationWarnings(); track w.tableId + w.type + w.message) {
            <div (click)="w.tableId && selectTableById(w.tableId); validationPanelOpen.set(false)"
                class="px-4 py-2 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 cursor-pointer transition-colors">
                <span class="text-[10px] uppercase text-amber-500 font-medium">{{ w.type }}</span>
                <p class="text-sm text-zinc-300">{{ w.message }}</p>
                @if (w.tableName) {
                <span class="text-xs text-zinc-500">{{ w.tableName }}</span>
                }
            </div>
            }
            }
        </div>
    </aside>
    <div class="fixed inset-0 bg-black/30 z-[55]" (click)="validationPanelOpen.set(false)"></div>
    }

    <!-- Panneau Templates -->
    @if (templatesPanelOpen()) {
    <aside class="fixed inset-y-0 right-0 w-80 border-l border-zinc-800 bg-zinc-950/95 backdrop-blur-md z-[60] flex flex-col animate-in slide-in-from-right duration-300">
        <div class="flex items-center justify-between p-6 border-b border-zinc-800">
            <h2 class="text-lg font-bold text-white">Templates</h2>
            <button (click)="templatesPanelOpen.set(false)" class="text-zinc-500 hover:text-white transition-colors">
                <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
            </button>
        </div>
        <div class="p-6 flex flex-col gap-3 overflow-y-auto">
            @for (tpl of SCHEMA_TEMPLATES; track tpl.name) {
            <button (click)="applyTemplate(tpl)"
                class="w-full px-4 py-3 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left">
                <span class="text-sm font-medium text-white block">{{ tpl.name }}</span>
                <span class="text-[10px] text-zinc-500">{{ tpl.desc }}</span>
            </button>
            }
        </div>
    </aside>
    <div class="fixed inset-0 bg-black/30 z-[55]" (click)="templatesPanelOpen.set(false)"></div>
    }

    <!-- Canvas -->
    <div #canvasRef class="flex-1 relative h-full overflow-hidden select-none"
        [class.cursor-grab]="spacePressed && !isPanning"
        [class.cursor-grabbing]="isPanning"
        [class.cursor-crosshair]="selectionBoxStart()"
        (click)="onCanvasClick($event)"
        (mousedown)="onCanvasMouseDown($event)"
        (dblclick)="onCanvasDblClick($event)" (mousemove)="onCanvasMouseMove($event)" (wheel)="onCanvasWheel($event)">
        <!-- Remote cursors -->
        @for (user of getRemoteCursors(); track user.userId) {
        <div class="absolute pointer-events-none z-50 transition-all duration-75"
            [style.left.px]="user.cursorX" [style.top.px]="user.cursorY"
            style="transform: translate(-2px, -2px);">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="drop-shadow-lg"
                [style.color]="getUserCursorColor(user.userId)">
                <path d="M5 3L5 21L9 17L13 21L14 20L10 16L19 16L5 3Z" fill="currentColor" stroke="white" stroke-width="1"/>
            </svg>
            <div class="ml-3 -mt-4 px-2 py-0.5 rounded text-[10px] font-medium whitespace-nowrap shadow-lg border border-white/20"
                [style.background]="getUserCursorColor(user.userId)" [style.color]="'white'">
                {{ user.displayName || user.email || 'Collaborateur' }}
            </div>
        </div>
        }
        <div #canvasTransform class="absolute inset-0 will-change-transform" [style.transform]="'translate(' + panOffsetX() + 'px, ' + panOffsetY() + 'px) scale(' + zoomLevel() + ')'" style="transform-origin: 0 0;">
            <!-- SVG Connections -->
            <svg class="absolute inset-0 w-full h-full z-0 overflow-visible">
                <defs>
                    <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                        <polygon points="0 0, 5 2, 0 4" fill="#6366f1" opacity="0.85"/>
                    </marker>
                    <marker id="arrowhead-selected" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                        <polygon points="0 0, 5 2, 0 4" fill="#818cf8" opacity="0.9"/>
                    </marker>
                </defs>
                @for (rel of getValidRelationships(); track rel.id) {
                <!-- Zone de clic (large) -->
                <path
                    [attr.d]="getRelationshipPath(rel)"
                    fill="none" stroke="transparent" stroke-width="14" stroke-linecap="round"
                    class="cursor-pointer"
                    [attr.stroke-dasharray]="rel.type === 'M:N' ? '4 4' : ''"
                    (click)="selectRelationship(rel.id, $event)">
                </path>
                <!-- Ligne visible : flèche(s) selon le type (1:1 aucune, M:N aux deux bouts, sinon → vers toTable) -->
                <path
                    [attr.d]="getRelationshipPath(rel)"
                    fill="none"
                    [attr.stroke]="selectedRelationshipId() === rel.id ? '#818cf8' : '#6366f1'"
                    [attr.marker-start]="rel.type === 'M:N' ? (selectedRelationshipId() === rel.id ? 'url(#arrowhead-selected)' : 'url(#arrowhead)') : 'none'"
                    [attr.marker-end]="rel.type === '1:1' ? 'none' : (selectedRelationshipId() === rel.id ? 'url(#arrowhead-selected)' : 'url(#arrowhead)')"
                    stroke-width="2"
                    stroke-linecap="round"
                    pointer-events="none"
                    [attr.stroke-dasharray]="rel.type === 'M:N' ? '4 4' : ''">
                </path>
                }
                @if (getPreviewPath(); as path) {
                <path [attr.d]="path" fill="none" stroke="#818cf8" stroke-width="2" stroke-dasharray="4 4" opacity="0.8" pointer-events="none">
                </path>
                }
            </svg>

            @if (getSelectionBoxRect(); as rect) {
            <div class="absolute border-2 border-indigo-500 bg-indigo-500/10 pointer-events-none z-10"
                [style.left.px]="rect.x" [style.top.px]="rect.y" [style.width.px]="rect.w" [style.height.px]="rect.h">
            </div>
            }

            <!-- Relationship badges (sur la ligne) - z-40 pour passer au-dessus des tables -->
            @for (rel of getValidRelationships(); track rel.id) {
            @let mid = getRelationshipMidpoint(rel);
            <div
                [style.left.px]="mid.x"
                [style.top.px]="mid.y"
                data-relationship-badge
                class="absolute z-40 -translate-x-1/2 -translate-y-1/2 cursor-pointer group/rel"
                (click)="selectRelationship(rel.id, $event)">
                <div
                    [class.border-indigo-500]="selectedRelationshipId() === rel.id"
                    class="bg-zinc-900 border rounded-full px-2 py-0.5 flex items-center gap-1.5 shadow-lg transition-colors hover:border-indigo-500/50 justify-center"
                    [class.border-zinc-700]="selectedRelationshipId() !== rel.id">
                    <span class="text-[10px] font-mono text-zinc-500 max-w-16 truncate" [title]="getTableName(rel.fromTableId)">{{ getTableName(rel.fromTableId) }}</span>
                    <iconify-icon icon="solar:arrow-right-linear" class="text-zinc-500 text-[10px] shrink-0"></iconify-icon>
                    <span class="text-[10px] font-mono text-zinc-500 max-w-16 truncate" [title]="getTableName(rel.toTableId)">{{ getTableName(rel.toTableId) }}</span>
                    <span class="text-zinc-600">·</span>
                    <iconify-icon icon="solar:link-linear"
                        [class]="rel.type === 'M:N' ? 'text-emerald-400 text-[10px]' : 'text-indigo-400 text-[10px]'"></iconify-icon>
                    <span class="text-[10px] font-medium text-zinc-300">{{ getRelationshipTypeLabel(rel.type) }}</span>
                </div>
                <!-- Menu déroulant : visible au survol OU quand la relation est sélectionnée (clic) -->
                <div
                    [class]="(selectedRelationshipId() === rel.id ? 'block' : 'hidden group-hover/rel:block') + ' absolute top-full left-1/2 -translate-x-1/2 pt-3 -mt-1 w-40 bg-zinc-900 border border-zinc-800 rounded-md shadow-xl overflow-hidden py-1 z-50'"
                    (click)="$event.stopPropagation()">
                    <div class="px-2 py-1.5 text-[10px] text-zinc-500 uppercase tracking-wider font-semibold">Cardinalité</div>
                    <button type="button" (click)="updateRelationshipType(rel.id, '1:1')"
                        class="w-full px-2 py-1.5 hover:bg-zinc-800 text-[10px] text-left flex justify-between items-center transition-colors"
                        [class.text-indigo-400]="rel.type === '1:1'"
                        [class.text-zinc-400]="rel.type !== '1:1'"
                        [class.bg-zinc-800/50]="rel.type === '1:1'">
                        One to One
                        @if (rel.type === '1:1') {
                        <iconify-icon icon="solar:check-circle-linear" class="text-indigo-400"></iconify-icon>
                        }
                    </button>
                    <button type="button" (click)="updateRelationshipType(rel.id, '1:N')"
                        class="w-full px-2 py-1.5 hover:bg-zinc-800 text-[10px] text-left flex justify-between items-center transition-colors"
                        [class.text-indigo-400]="rel.type === '1:N'"
                        [class.text-zinc-400]="rel.type !== '1:N'"
                        [class.bg-zinc-800/50]="rel.type === '1:N'">
                        One to Many
                        @if (rel.type === '1:N') {
                        <iconify-icon icon="solar:check-circle-linear" class="text-indigo-400"></iconify-icon>
                        }
                    </button>
                    <button type="button" (click)="updateRelationshipType(rel.id, 'M:N')"
                        class="w-full px-2 py-1.5 hover:bg-zinc-800 text-[10px] text-left flex justify-between items-center transition-colors"
                        [class.text-emerald-400]="rel.type === 'M:N'"
                        [class.text-zinc-400]="rel.type !== 'M:N'"
                        [class.bg-zinc-800/50]="rel.type === 'M:N'">
                        Many to Many
                        @if (rel.type === 'M:N') {
                        <iconify-icon icon="solar:check-circle-linear" class="text-emerald-400"></iconify-icon>
                        }
                    </button>
                    <div class="border-t border-zinc-800 my-1"></div>
                    <button type="button" (click)="reverseRelationshipDirection(rel.id)"
                        class="w-full px-2 py-1.5 hover:bg-zinc-800 text-[10px] text-zinc-400 hover:text-white flex items-center gap-2 transition-colors">
                        <iconify-icon icon="solar:refresh-linear" class="text-xs"></iconify-icon>
                        Inverser la direction
                    </button>
                    <button type="button" (click)="removeRelationship(rel.id)"
                        class="w-full px-2 py-1.5 hover:bg-red-500/10 text-[10px] text-red-400 hover:text-red-300 flex items-center gap-2 transition-colors">
                        <iconify-icon icon="solar:trash-bin-trash-linear" class="text-xs"></iconify-icon>
                        Supprimer
                    </button>
                </div>
            </div>
            }

            <!-- Tables -->
            @for (table of tables(); track table.id) {
            <div [style.left.px]="table.x" [style.top.px]="table.y" data-table-card
                [class.opacity-40]="!tableMatchesSearch(table)"
                [class.pointer-events-none]="!tableMatchesSearch(table)"
                (click)="$event.stopPropagation(); selectTable(table.id, $event)" cdkDrag
                (cdkDragEnded)="onDragEnded($event, table)" [class.border-indigo-500]="isTableSelected(table.id)"
                [class.ring-2]="isTableSelected(table.id)"
                [class.ring-indigo-500/50]="isTableSelected(table.id)"
                [class.z-30]="isTableSelected(table.id)"
                [class.border-amber-500/50]="getTableWarningCount(table.id) > 0"
                class="absolute w-64 bg-[#1c1c1f] border border-[#3f3f46] rounded-lg shadow-2xl flex flex-col z-20 hover:border-indigo-500/50 transition-colors group active:scale-[0.98] cursor-pointer relative">
                <!-- Connection points -->
                <button type="button" data-connection-point [attr.data-table-id]="table.id" data-side="top"
                    (mousedown)="onConnectionPointMouseDown(table.id, 'top', $event)"
                    (click)="onConnectionPointClick(table.id, 'top', $event)"
                    [class.ring-2]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'top'"
                    [class.ring-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'top'"
                    [class.bg-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'top'"
                    class="connection-point connection-point-top" title="Point de connexion">
                </button>
                <button type="button" data-connection-point [attr.data-table-id]="table.id" data-side="right"
                    (mousedown)="onConnectionPointMouseDown(table.id, 'right', $event)"
                    (click)="onConnectionPointClick(table.id, 'right', $event)"
                    [class.ring-2]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'right'"
                    [class.ring-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'right'"
                    [class.bg-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'right'"
                    class="connection-point connection-point-right" title="Point de connexion">
                </button>
                <button type="button" data-connection-point [attr.data-table-id]="table.id" data-side="bottom"
                    (mousedown)="onConnectionPointMouseDown(table.id, 'bottom', $event)"
                    (click)="onConnectionPointClick(table.id, 'bottom', $event)"
                    [class.ring-2]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'bottom'"
                    [class.ring-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'bottom'"
                    [class.bg-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'bottom'"
                    class="connection-point connection-point-bottom" title="Point de connexion">
                </button>
                <button type="button" data-connection-point [attr.data-table-id]="table.id" data-side="left"
                    (mousedown)="onConnectionPointMouseDown(table.id, 'left', $event)"
                    (click)="onConnectionPointClick(table.id, 'left', $event)"
                    [class.ring-2]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'left'"
                    [class.ring-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'left'"
                    [class.bg-indigo-500]="connectingFrom()?.tableId === table.id && connectingFrom()?.side === 'left'"
                    class="connection-point connection-point-left" title="Point de connexion">
                </button>
                <!-- Header -->
                <div cdkDragHandle
                    class="p-3 border-b border-[#27272a] flex items-center justify-between bg-[#1c1c1f]/80 rounded-t-lg handle cursor-move">
                    <div class="flex items-center gap-2 min-w-0 flex-1">
                        <iconify-icon [icon]="table.icon" class="text-indigo-400 text-lg shrink-0"></iconify-icon>
                        <input type="text" [(ngModel)]="table.name" (focus)="pushState()" (ngModelChange)="scheduleAutoSave()" (click)="$event.stopPropagation()"
                            class="bg-transparent border-none text-sm font-bold text-white focus:outline-none focus:ring-0 w-32 p-0 tracking-tight placeholder-zinc-600">
                        @if ((table.fields || []).length > FOLD_THRESHOLD) {
                        <button type="button" (click)="toggleTableFold(table.id, $event)"
                            class="shrink-0 p-1 rounded text-zinc-500 hover:text-indigo-400 hover:bg-indigo-500/10 transition-colors"
                            [title]="isTableFolded(table.id) ? 'Déplier' : 'Replier'">
                            <iconify-icon [icon]="isTableFolded(table.id) ? 'solar:alt-arrow-down-linear' : 'solar:alt-arrow-up-linear'" class="text-sm"></iconify-icon>
                        </button>
                        }
                    </div>
                    @if (getTableWarningCount(table.id) > 0) {
                    <button (click)="$event.stopPropagation(); validationPanelOpen.set(true)"
                        class="shrink-0 p-1 rounded text-amber-500 hover:bg-amber-500/10 transition-colors"
                        [title]="getTableWarningCount(table.id) + ' avertissement(s)'">
                        <iconify-icon icon="solar:danger-triangle-linear" class="text-sm"></iconify-icon>
                    </button>
                    }
                    <button (click)="$event.stopPropagation(); removeTable(table.id)"
                        class="text-zinc-600 hover:text-red-400 transition-colors shrink-0">
                        <iconify-icon icon="solar:trash-bin-trash-linear"></iconify-icon>
                    </button>
                </div>
                <!-- Fields -->
                <div class="flex flex-col min-h-0 max-h-[320px] overflow-y-auto" data-table-fields-scroll>
                    @let visible = getVisibleFields(table);
                    @for (field of visible.fields; track field.id) {
                    <div
                        class="px-3 py-2 border-b border-[#27272a]/50 flex items-center gap-2 hover:bg-[#27272a]/50 group/field relative">
                        @if (field.isPrimary) {
                        <iconify-icon icon="solar:key-linear" class="text-yellow-500 text-xs shrink-0"></iconify-icon>
                        } @else if (field.type === 'Relation') {
                        <iconify-icon icon="solar:link-linear" class="text-indigo-400 text-xs shrink-0"></iconify-icon>
                        } @else {
                        <div class="w-3 h-3 border border-[#3f3f46] rounded-sm shrink-0"></div>
                        }
                        <input type="text" [(ngModel)]="field.name" (focus)="pushState()" (ngModelChange)="scheduleAutoSave()" (click)="$event.stopPropagation()"
                            class="flex-1 min-w-0 bg-transparent border-none text-xs font-mono text-zinc-200 focus:outline-none focus:ring-0 p-0">
                        <button type="button" (click)="removeField(table.id, field.id, $event)"
                            class="shrink-0 p-1 rounded text-zinc-500 hover:text-red-400 hover:bg-red-500/10 opacity-0 group-hover/field:opacity-100 transition-all"
                            title="Supprimer la propriété">
                            <iconify-icon icon="solar:trash-bin-trash-linear" class="text-xs"></iconify-icon>
                        </button>
                        <span [class]="'text-[10px] px-1.5 py-0.5 rounded font-medium shrink-0 ' + 
                  (field.isPrimary ? 'text-yellow-500 bg-yellow-500/10' : 
                   field.type === 'Relation' ? 'text-indigo-400 bg-indigo-500/10 border border-indigo-500/20' :
                   field.type === 'number' || field.type === 'integer' ? 'text-emerald-400 bg-emerald-500/10' :
                   field.type === 'boolean' ? 'text-amber-400 bg-amber-500/10' :
                   field.type === 'text' ? 'text-cyan-400 bg-cyan-500/10' :
                   field.type === 'date' || field.type === 'timestamp' ? 'text-orange-400 bg-orange-500/10' :
                   field.type === 'json' ? 'text-pink-400 bg-pink-500/10' :
                   field.type === 'uuid' ? 'text-yellow-500 bg-yellow-500/10' :
                   field.type === 'enum' ? 'text-purple-400 bg-purple-500/10' :
                   'text-blue-400 bg-blue-500/10')">
                            {{ field.type === 'enum' ? (getEnumValues(field).length ? getEnumValues(field).join(', ') : (field.enumRef || 'enum')) : (field.faker || field.type) }}
                        </span>
                    </div>
                    }
                    @if (visible.hiddenCount > 0) {
                    <button type="button" (click)="$event.stopPropagation(); toggleTableFold(table.id)"
                        class="px-3 py-2 flex items-center gap-2 hover:bg-[#27272a]/50 cursor-pointer text-zinc-500 hover:text-indigo-400 transition-colors text-left">
                        <iconify-icon icon="solar:alt-arrow-down-linear" class="text-sm"></iconify-icon>
                        <span class="text-xs font-medium">+ {{ visible.hiddenCount }} propriété(s)</span>
                    </button>
                    }
                    <div (click)="$event.stopPropagation(); addField(table.id)"
                        class="px-3 py-2 flex items-center gap-2 hover:bg-[#27272a]/30 group/field cursor-pointer text-zinc-500 hover:text-zinc-300 transition-colors">
                        <iconify-icon icon="solar:add-circle-linear" class="text-sm"></iconify-icon>
                        <span class="text-xs font-medium">Add Property</span>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>

    <!-- Properties Panel -->
    @if (selectedTable; as sTable) {
    <aside
        class="w-80 border-l border-zinc-800 bg-zinc-950/50 backdrop-blur-md p-6 flex flex-col gap-6 animate-in slide-in-from-right duration-300">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-white">Table Properties</h2>
            <button (click)="clearSelection()" class="text-zinc-500 hover:text-white">
                <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest mb-3 block">Enums (réutilisables)</label>
                <div class="space-y-2 mb-4 max-h-[200px] overflow-y-auto pr-2">
                    @for (e of enums(); track e.name) {
                    <div class="p-2 bg-[#1c1c1f]/50 border border-[#27272a] rounded-md">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-mono text-purple-400">{{ e.name }}</span>
                            <button type="button" (click)="removeEnum(e.name)" class="text-zinc-500 hover:text-red-400 text-[10px]">
                                <iconify-icon icon="solar:trash-bin-trash-linear"></iconify-icon>
                            </button>
                        </div>
                        <div class="flex flex-wrap gap-1 mb-1">
                            @for (val of e.values; track $index) {
                            <span class="inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-300 text-[10px]">
                                {{ val }}
                                <button type="button" (click)="removeEnumValue(e.name, $index)" class="hover:text-red-400">
                                    <iconify-icon icon="solar:close-circle-linear" class="text-[10px]"></iconify-icon>
                                </button>
                            </span>
                            }
                        </div>
                        <div class="flex gap-1">
                            <input type="text" #enumVal [id]="'enum-val-' + e.name" placeholder="+ valeur"
                                class="flex-1 bg-[#27272a] border border-zinc-700 rounded px-1.5 py-0.5 text-[10px] text-white placeholder-zinc-500 focus:border-indigo-500 outline-none"
                                (keydown.enter)="addEnumValue(e.name, enumVal); $event.preventDefault()">
                            <button type="button" (click)="addEnumValue(e.name, enumVal)"
                                class="px-1.5 py-0.5 rounded bg-indigo-500/20 text-indigo-400 text-[10px]">
                                <iconify-icon icon="solar:add-circle-linear"></iconify-icon>
                            </button>
                        </div>
                    </div>
                    }
                </div>
                <div class="flex gap-1">
                    <input type="text" #newEnumName placeholder="Nom du nouvel enum"
                        class="flex-1 bg-[#27272a] border border-zinc-700 rounded px-2 py-1 text-[10px] text-white placeholder-zinc-500 focus:border-indigo-500 outline-none"
                        (keydown.enter)="addEnum(newEnumName.value); newEnumName.value = ''; $event.preventDefault()">
                    <button type="button" (click)="addEnum(newEnumName.value); newEnumName.value = ''"
                        class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-[10px] hover:bg-purple-500/30">
                        <iconify-icon icon="solar:add-circle-linear"></iconify-icon>
                    </button>
                </div>
            </div>

            <div>
                <label class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest mb-1.5 block">Table
                    Name</label>
                <input type="text" [(ngModel)]="sTable.name" (focus)="pushState()" (ngModelChange)="scheduleAutoSave()"
                    class="w-full bg-[#1c1c1f] border border-[#27272a] rounded-md px-3 py-2 text-sm text-white focus:border-indigo-500 outline-none transition-colors">
            </div>

            <div>
                <label class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest mb-3 block">Columns ({{
                    sTable.fields.length }})</label>
                <div class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                    @for (field of sTable.fields; track field.id) {
                    <div class="p-3 bg-[#1c1c1f]/50 border border-[#27272a] rounded-md group">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="text" [(ngModel)]="field.name" (focus)="pushState()" (ngModelChange)="scheduleAutoSave()"
                                class="bg-transparent border-none text-xs font-mono text-indigo-300 p-0 flex-1 min-w-0 focus:ring-0">
                            <button type="button" (click)="removeField(sTable.id, field.id)"
                                class="p-1.5 rounded text-zinc-500 hover:text-red-400 hover:bg-red-500/10 transition-colors shrink-0"
                                title="Supprimer la propriété">
                                <iconify-icon icon="solar:trash-bin-trash-linear" class="text-sm"></iconify-icon>
                            </button>
                        </div>
                        <div class="flex flex-col gap-2">
                            @if (field.type === 'Relation') {
                            <span class="text-[10px] text-indigo-400">Relation (clé étrangère)</span>
                            } @else {
                            <select [(ngModel)]="field.type" (focus)="pushState()" (ngModelChange)="onFieldTypeChange(field)"
                                class="bg-[#27272a] border-none text-[10px] text-zinc-400 rounded px-1.5 py-0.5 outline-none w-fit">
                                <option value="string">String</option>
                                <option value="number">Number</option>
                                <option value="integer">Integer</option>
                                <option value="boolean">Boolean</option>
                                <option value="text">Text</option>
                                <option value="date">Date</option>
                                <option value="timestamp">Timestamp</option>
                                <option value="json">JSON</option>
                                <option value="uuid">UUID</option>
                                <option value="enum">Enum</option>
                            </select>
                            @if (field.type === 'enum') {
                            <div class="mt-1">
                                <label class="text-[10px] text-zinc-500 mb-1 block">Enum</label>
                                <select [(ngModel)]="field.enumRef" (ngModelChange)="scheduleAutoSave()"
                                    class="w-full bg-[#27272a] border border-zinc-700 rounded px-2 py-1 text-[10px] text-white focus:border-indigo-500 outline-none">
                                    @for (e of enums(); track e.name) {
                                    <option [value]="e.name">{{ e.name }} ({{ e.values.length }} valeurs)</option>
                                    }
                                    @if (enums().length === 0) {
                                    <option value="" disabled>Créez un enum ci-dessous</option>
                                    }
                                </select>
                            </div>
                            }
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        <div class="mt-auto pt-6 border-t border-zinc-800">
            <button (click)="removeTable(sTable.id)"
                class="w-full py-2.5 rounded-md border border-red-500/30 text-red-400 text-xs font-semibold hover:bg-red-500/10 transition-colors flex items-center justify-center gap-2">
                <iconify-icon icon="solar:trash-bin-trash-linear" class="text-sm"></iconify-icon>
                Delete Table
            </button>
        </div>
    </aside>
    }

</main>

<!-- Sidenav Export -->
@if (exportPanelOpen()) {
<aside
    class="fixed inset-y-0 right-0 w-80 border-l border-zinc-800 bg-zinc-950/95 backdrop-blur-md z-[60] flex flex-col animate-in slide-in-from-right duration-300">
    <div class="flex items-center justify-between p-6 border-b border-zinc-800">
        <h2 class="text-lg font-bold text-white">Exporter le schéma</h2>
        <button (click)="exportPanelOpen.set(false)" class="text-zinc-500 hover:text-white transition-colors">
            <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
        </button>
    </div>
    <div class="p-6 flex flex-col gap-4 overflow-y-auto">
        <!-- Switch fausses données -->
        <div class="flex items-center justify-between gap-3">
            <span class="text-sm text-zinc-300">Générer des fausses données</span>
            <button type="button" role="switch" [attr.aria-checked]="exportWithFakeData()"
                (click)="exportWithFakeData.set(!exportWithFakeData())"
                [class.bg-indigo-500]="exportWithFakeData()"
                [class.bg-zinc-700]="!exportWithFakeData()"
                class="relative inline-flex h-6 w-11 shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:ring-offset-2 focus:ring-offset-zinc-950">
                <span [class.translate-x-5]="exportWithFakeData()" [class.translate-x-1]="!exportWithFakeData()"
                    class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200"></span>
            </button>
        </div>

        @if (exportWithFakeData()) {
        <div class="space-y-4">
            <label class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest block">Lignes par table</label>
            @for (table of tables(); track table.id) {
            <div class="flex items-center justify-between gap-3">
                <span class="text-sm text-zinc-300 truncate">{{ table.name }}</span>
                <input type="number" min="0" [ngModel]="getExportRowCount(table.id)"
                    (ngModelChange)="setExportRowCount(table.id, +$event)"
                    class="w-20 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-sm text-white focus:border-indigo-500 outline-none">
            </div>
            }
        </div>
        <div class="border-t border-zinc-800 pt-4"></div>
        }

        <div class="flex flex-col gap-3">
            <button (click)="exportSql(); exportPanelOpen.set(false)"
                class="flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left">
                <iconify-icon icon="solar:database-linear" class="text-indigo-400 text-xl"></iconify-icon>
                <div>
                    <span class="text-sm font-medium text-white block">SQL</span>
                    <span class="text-[10px] text-zinc-500">{{ exportWithFakeData() ? 'Schema + INSERT' : 'Script CREATE TABLE' }}</span>
                </div>
            </button>
            <button (click)="exportJson(); exportPanelOpen.set(false)"
                class="flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left">
                <iconify-icon icon="solar:document-code-linear" class="text-indigo-400 text-xl"></iconify-icon>
                <div>
                    <span class="text-sm font-medium text-white block">JSON</span>
                    <span class="text-[10px] text-zinc-500">{{ exportWithFakeData() ? 'Schema + données' : 'Tables et relations' }}</span>
                </div>
            </button>
            <button (click)="exportPrisma(); exportPanelOpen.set(false)"
                class="flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left">
                <iconify-icon icon="solar:code-square-linear" class="text-indigo-400 text-xl"></iconify-icon>
                <div>
                    <span class="text-sm font-medium text-white block">Prisma</span>
                    <span class="text-[10px] text-zinc-500">Schema Prisma (.prisma)</span>
                </div>
            </button>
            <button (click)="exportTypeORM(); exportPanelOpen.set(false)"
                class="flex items-center gap-3 w-full px-4 py-3 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:bg-zinc-800 hover:border-zinc-700 transition-colors text-left">
                <iconify-icon icon="solar:programming-linear" class="text-indigo-400 text-xl"></iconify-icon>
                <div>
                    <span class="text-sm font-medium text-white block">TypeORM</span>
                    <span class="text-[10px] text-zinc-500">Entités TypeORM (.ts)</span>
                </div>
            </button>
        </div>
    </div>
</aside>
<!-- Overlay pour fermer au clic extérieur -->
<div class="fixed inset-0 bg-black/30 z-[55]" (click)="exportPanelOpen.set(false)"></div>
}

<!-- Panneau Import SQL / JSON -->
@if (importPanelOpen()) {
<aside
    class="fixed inset-y-0 right-0 w-96 border-l border-zinc-800 bg-zinc-950/95 backdrop-blur-md z-[60] flex flex-col animate-in slide-in-from-right duration-300">
    <div class="flex items-center justify-between p-6 border-b border-zinc-800">
        <h2 class="text-lg font-bold text-white">Importer</h2>
        <button (click)="importPanelOpen.set(false)" class="text-zinc-500 hover:text-white transition-colors">
            <iconify-icon icon="solar:close-circle-linear" class="text-xl"></iconify-icon>
        </button>
    </div>
    <div class="flex border-b border-zinc-800">
        <button (click)="importMode.set('sql'); importError.set(null)"
            [class.bg-zinc-800]="importMode() === 'sql'"
            [class.text-white]="importMode() === 'sql'"
            [class.text-zinc-500]="importMode() !== 'sql'"
            class="flex-1 py-2 px-4 text-sm font-medium transition-colors">SQL</button>
        <button (click)="importMode.set('json'); importError.set(null)"
            [class.bg-zinc-800]="importMode() === 'json'"
            [class.text-white]="importMode() === 'json'"
            [class.text-zinc-500]="importMode() !== 'json'"
            class="flex-1 py-2 px-4 text-sm font-medium transition-colors">JSON</button>
    </div>
    <div class="p-6 flex flex-col gap-4 overflow-y-auto flex-1">
        @if (importMode() === 'sql') {
        <p class="text-sm text-zinc-400">Collez ou glissez-déposez un fichier .sql (CREATE TABLE). Les clés étrangères (REFERENCES) créent automatiquement les relations.</p>
        <div class="relative"
            (dragover)="onImportFileDragOver($event)"
            (dragleave)="onImportFileDragLeave()"
            (drop)="onImportFileDrop($event)">
            <textarea
                [ngModel]="importSqlContent()"
                (ngModelChange)="importSqlContent.set($event); importError.set(null)"
                placeholder="CREATE TABLE users (&#10;  id BIGINT PRIMARY KEY,&#10;  name VARCHAR(255)&#10;);&#10;&#10;CREATE TABLE orders (&#10;  id BIGINT PRIMARY KEY,&#10;  user_id BIGINT REFERENCES users(id)&#10;);"
                class="w-full h-64 bg-zinc-900 border rounded-lg px-4 py-3 text-sm text-white font-mono placeholder-zinc-600 focus:border-indigo-500 outline-none resize-none transition-colors"
                [class.border-indigo-500]="importDropActive()"
                [class.border-zinc-700]="!importDropActive()"
                [class.bg-indigo-500/5]="importDropActive()"></textarea>
            @if (importDropActive()) {
            <div class="absolute inset-0 flex items-center justify-center rounded-lg border-2 border-dashed border-indigo-500 bg-indigo-500/10 pointer-events-none">
                <span class="text-indigo-400 font-medium">Déposez le fichier .sql</span>
            </div>
            }
        </div>
        } @else {
        <p class="text-sm text-zinc-400">Collez ou glissez-déposez un fichier .json exporté par CoSchemaLab (tables, relationships, enums).</p>
        <div class="relative"
            (dragover)="onImportJsonDragOver($event)"
            (dragleave)="onImportFileDragLeave()"
            (drop)="onImportJsonDrop($event)">
            <textarea
                [ngModel]="importJsonContent()"
                (ngModelChange)="importJsonContent.set($event); importError.set(null)"
                placeholder="{&#10;  &quot;tables&quot;: [...],&#10;  &quot;relationships&quot;: [...]&#10;}"
                class="w-full h-64 bg-zinc-900 border rounded-lg px-4 py-3 text-sm text-white font-mono placeholder-zinc-600 focus:border-indigo-500 outline-none resize-none transition-colors"
                [class.border-indigo-500]="importDropActive()"
                [class.border-zinc-700]="!importDropActive()"
                [class.bg-indigo-500/5]="importDropActive()"></textarea>
            @if (importDropActive()) {
            <div class="absolute inset-0 flex items-center justify-center rounded-lg border-2 border-dashed border-indigo-500 bg-indigo-500/10 pointer-events-none">
                <span class="text-indigo-400 font-medium">Déposez le fichier .json</span>
            </div>
            }
        </div>
        }
        @if (importError(); as err) {
        <div class="text-sm text-red-400">{{ err }}</div>
        }
        <button (click)="importMode() === 'sql' ? importFromSql() : importFromJson()"
            class="w-full py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors flex items-center justify-center gap-2">
            <iconify-icon icon="solar:import-linear"></iconify-icon>
            Importer
        </button>
    </div>
</aside>
<div class="fixed inset-0 bg-black/30 z-[55]" (click)="importPanelOpen.set(false)"></div>
}

<!-- Mini-carte -->
<div class="absolute bottom-5 right-5 z-50">
    <svg width="120" height="80" class="rounded-lg border border-zinc-700 bg-zinc-900/90 cursor-pointer"
        (click)="onMinimapClick($event)" viewBox="0 0 120 80" preserveAspectRatio="xMidYMid meet">
        @let md = getMinimapData();
        @for (t of md.tables; track $index) {
        <rect [attr.x]="t.x" [attr.y]="t.y" [attr.width]="t.w" [attr.height]="t.h" fill="#3f3f46" stroke="#52525b" stroke-width="0.5" rx="2"/>
        }
        <rect [attr.x]="md.viewport.x" [attr.y]="md.viewport.y" [attr.width]="md.viewport.w" [attr.height]="md.viewport.h"
            fill="none" stroke="#6366f1" stroke-width="1.5" opacity="0.8"/>
    </svg>
</div>

<div class="absolute bottom-5 left-5 z-50 flex flex-col gap-3">
    <div class="flex items-center gap-3">
        <span class="text-[10px] text-zinc-400 font-mono w-10">{{ Math.round(zoomLevel() * 100) }}%</span>
        <input type="range" min="50" max="200" [value]="Math.round(zoomLevel() * 100)"
            (input)="setZoomFromSlider($any($event.target).value)"
            class="zoom-slider w-28 appearance-none cursor-pointer">
    </div>
    <span class="text-[10px] text-zinc-600 select-none flex items-center gap-2">
        @if (connectingFrom()) {
        <span class="flex items-center gap-2">
            <span class="text-amber-400">Type :</span>
            <button type="button" (click)="connectingType.set('1:1')"
                [class.bg-indigo-500]="connectingType() === '1:1'"
                [class.text-white]="connectingType() === '1:1'"
                [class.bg-zinc-800]="connectingType() !== '1:1'"
                class="px-1.5 py-0.5 rounded text-[10px] font-medium hover:bg-zinc-700 transition-colors">1:1</button>
            <button type="button" (click)="connectingType.set('1:N')"
                [class.bg-indigo-500]="connectingType() === '1:N'"
                [class.text-white]="connectingType() === '1:N'"
                [class.bg-zinc-800]="connectingType() !== '1:N'"
                class="px-1.5 py-0.5 rounded text-[10px] font-medium hover:bg-zinc-700 transition-colors">1:N</button>
            <button type="button" (click)="connectingType.set('M:N')"
                [class.bg-indigo-500]="connectingType() === 'M:N'"
                [class.text-white]="connectingType() === 'M:N'"
                [class.bg-zinc-800]="connectingType() !== 'M:N'"
                class="px-1.5 py-0.5 rounded text-[10px] font-medium hover:bg-zinc-700 transition-colors">M:N</button>
            <span class="text-zinc-500">·</span>
            <span class="text-amber-400">Cliquez sur un point pour connecter · Échap pour annuler</span>
        </span>
        } @else {
        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
        Deux doigts pour déplacer · Ctrl+molette pour zoom · {{ tables().length }} Tables · {{ getValidRelationships().length }} Connections
        }
    </span>
</div>
}